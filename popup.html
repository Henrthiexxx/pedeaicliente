<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
  <title>Produto</title>
  <style>
    :root{
      --bg:#0a0a0a;--card:#111;--input:#171717;--text:#fff;--muted:#737373;
      --border:#262626;--primary:#fff;--radius:14px;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{padding:16px;max-width:520px;margin:0 auto}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-weight:700;font-size:1.05rem}
    .btn-x{width:38px;height:38px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:12px}
    .img{width:100%;height:180px;border-radius:14px;border:1px solid var(--border);background:var(--input);overflow:hidden;display:flex;align-items:center;justify-content:center}
    .img img{width:100%;height:100%;object-fit:cover;display:block}
    .name{font-weight:800;font-size:1.15rem;margin-top:12px}
    .desc{color:var(--muted);font-size:.88rem;margin-top:6px;line-height:1.35}
    .row{display:flex;align-items:center;justify-content:space-between;margin-top:12px}
    .price{font-weight:800;font-size:1.08rem}
    .qty{display:flex;gap:10px;align-items:center}
    .qty button{width:36px;height:36px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-size:1.1rem}
    .qty span{min-width:24px;text-align:center;font-weight:700}
    .sec-title{font-weight:800;font-size:.9rem;margin-bottom:8px}
    .hint{color:var(--muted);font-size:.78rem;margin:-2px 0 10px 0}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      padding:10px 12px;border-radius:999px;border:1px solid var(--border);
      background:transparent;color:var(--text);cursor:pointer;font-size:.88rem
    }
    .chip.active{background:var(--primary);color:#000;border-color:var(--primary)}
    .line{height:1px;background:var(--border);margin:12px 0}
    .check{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border:1px solid var(--border);border-radius:14px;background:var(--input);
      margin-bottom:8px;cursor:pointer
    }
    .check small{color:var(--muted)}
    .btn-main{
      width:100%;padding:14px;border-radius:14px;border:1px solid var(--primary);
      background:var(--primary);color:#000;font-weight:900;cursor:pointer
    }
    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:var(--card);border:1px solid var(--border);padding:10px 14px;border-radius:12px;
      opacity:0;pointer-events:none;transition:.2s
    }
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>

  <div class="wrap">
    <div class="top">
      <div class="title">Produto</div>
      <button class="btn-x" onclick="closeMe()">‚úï</button>
    </div>

    <div class="card">
      <div class="img" id="pImg"><div style="color:var(--muted)">Carregando...</div></div>
      <div class="name" id="pName">-</div>
      <div class="desc" id="pDesc"></div>

      <div class="row">
        <div class="price" id="pPrice">R$ 0,00</div>
        <div class="qty">
          <button onclick="setQty(-1)">‚àí</button>
          <span id="qtyVal">1</span>
          <button onclick="setQty(1)">+</button>
        </div>
      </div>
    </div>

    <div class="card" id="optFlavors" style="display:none;">
      <div class="sec-title">üçï Sabores</div>
      <div class="hint">Escolha 1</div>
      <div class="chips" id="flavorsChips"></div>
    </div>

    <div class="card" id="optSizes" style="display:none;">
      <div class="sec-title">üìè Tamanhos</div>
      <div class="hint">Escolha 1</div>
      <div class="chips" id="sizesChips"></div>
    </div>

    <div class="card" id="optExtras" style="display:none;">
      <div class="sec-title">‚ûï Extras</div>
      <div class="hint">Escolha quantos quiser</div>
      <div id="extrasList"></div>
    </div>

    <div class="card">
      <div class="row">
        <div style="color:var(--muted);font-size:.9rem">Total</div>
        <div class="price" id="totalPrice">R$ 0,00</div>
      </div>
      <div class="line"></div>
      <button class="btn-main" onclick="sendToCart()">Adicionar ao carrinho</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAnIJRcUxN-0swpVnonPbJjTSK87o4CQ_g",
      authDomain: "pedrad-814d0.firebaseapp.com",
      projectId: "pedrad-814d0",
      storageBucket: "pedrad-814d0.firebasestorage.app",
      messagingSenderId: "293587190550",
      appId: "1:293587190550:web:80c9399f82847c80e20637"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ====== state ======
    const qs = new URLSearchParams(location.search);
    const storeId = qs.get("storeId") || localStorage.getItem("currentStoreId");
    const productId = qs.get("productId");
    let product = null;

    let qty = 1;
    let selectedFlavor = null; // {name, price}
    let selectedSize = null;   // {name, price}
    let selectedExtras = [];   // [{name,price}]

    // ====== utils ======
    const money = (v)=> new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(Number(v||0));
    const toast = (m)=>{
      const t=document.getElementById("toast");
      t.textContent=m; t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"),1800);
    };
    const hasHttpImage = (u)=>{
      if(!u) return false;
      const s=String(u).trim();
      if(!s) return false;
      if(!/^https?:\/\//i.test(s)) return false;
      if(s.includes(" ")) return false;
      return true;
    };

    function closeMe(){
      window.parent?.postMessage({type:"closePopup"}, "*");
    }

    function setQty(delta){
      qty = Math.max(1, qty + delta);
      document.getElementById("qtyVal").textContent = qty;
      calcTotal();
    }

    function sanitizeOpts(arr){
      if(!Array.isArray(arr)) return [];
      return arr
        .filter(x=>x && typeof x==="object")
        .map((x,i)=>({
          name:String(x.name||"").trim(),
          price: Number(parseFloat(x.price)) || 0,
          order: typeof x.order==="number" ? x.order : i
        }))
        .filter(x=>x.name)
        .sort((a,b)=>a.order-b.order);
    }

    function calcTotal(){
      if(!product) return;
      const base = Number(product.price||0);
      const f = selectedFlavor?.price || 0;
      const s = selectedSize?.price || 0;
      const ex = selectedExtras.reduce((sum,e)=>sum+(e.price||0),0);
      const unit = base + f + s + ex;
      document.getElementById("pPrice").textContent = money(unit); // pre√ßo unit√°rio atual
      document.getElementById("totalPrice").textContent = money(unit * qty);
    }

    function pickFlavor(i){
      const opts = sanitizeOpts(product.flavors);
      selectedFlavor = opts[i] || null;
      document.querySelectorAll("#flavorsChips .chip").forEach((c,idx)=>c.classList.toggle("active", idx===i));
      calcTotal();
    }

    function pickSize(i){
      const opts = sanitizeOpts(product.sizes);
      selectedSize = opts[i] || null;
      document.querySelectorAll("#sizesChips .chip").forEach((c,idx)=>c.classList.toggle("active", idx===i));
      calcTotal();
    }

    function toggleExtra(i){
      const opts = sanitizeOpts(product.extras);
      const it = opts[i];
      if(!it) return;

      const exists = selectedExtras.find(x=>x.name===it.name);
      if(exists) selectedExtras = selectedExtras.filter(x=>x.name!==it.name);
      else selectedExtras.push(it);

      renderExtras(); // atualiza check visual
      calcTotal();
    }

    // ====== render ======
    function renderProduct(){
      document.getElementById("pName").textContent = product.name || "Produto";
      document.getElementById("pDesc").textContent = product.description || "";

      // imagem
      const imgBox = document.getElementById("pImg");
      const imgUrl = (product.imageUrl || "").trim();
      if(hasHttpImage(imgUrl)){
        imgBox.innerHTML = `<img src="${imgUrl}" alt="${(product.name||"").replaceAll('"',"")}" onerror="this.remove();this.parentElement.innerHTML='<div style=color:var(--muted)>Sem imagem</div>';">`;
      }else{
        imgBox.innerHTML = `<div style="color:var(--muted);font-size:.9rem;">Sem imagem</div>`;
      }

      // sabores
      const flavors = sanitizeOpts(product.flavors);
      const flavorsWrap = document.getElementById("optFlavors");
      const flavorsChips = document.getElementById("flavorsChips");
      if(flavors.length){
        flavorsWrap.style.display="block";
        flavorsChips.innerHTML = flavors.map((f,idx)=>`
          <button class="chip ${idx===0?'active':''}" onclick="pickFlavor(${idx})">
            ${escapeHtml(f.name)}${f.price?` (+${money(f.price)})`:``}
          </button>
        `).join("");
        selectedFlavor = flavors[0]; // default 1¬∫
      }else{
        flavorsWrap.style.display="none";
        selectedFlavor = null;
      }

      // tamanhos
      const sizes = sanitizeOpts(product.sizes);
      const sizesWrap = document.getElementById("optSizes");
      const sizesChips = document.getElementById("sizesChips");
      if(sizes.length){
        sizesWrap.style.display="block";
        sizesChips.innerHTML = sizes.map((s,idx)=>`
          <button class="chip ${idx===0?'active':''}" onclick="pickSize(${idx})">
            ${escapeHtml(s.name)}${s.price?` (+${money(s.price)})`:``}
          </button>
        `).join("");
        selectedSize = sizes[0]; // default 1¬∫
      }else{
        sizesWrap.style.display="none";
        selectedSize = null;
      }

      // extras
      const extras = sanitizeOpts(product.extras);
      const extrasWrap = document.getElementById("optExtras");
      if(extras.length){
        extrasWrap.style.display="block";
        selectedExtras = [];
        renderExtras();
      }else{
        extrasWrap.style.display="none";
        selectedExtras = [];
      }

      calcTotal();
    }

    function renderExtras(){
      const extras = sanitizeOpts(product.extras);
      const box = document.getElementById("extrasList");
      box.innerHTML = extras.map((e,idx)=>{
        const on = !!selectedExtras.find(x=>x.name===e.name);
        return `
          <div class="check" onclick="toggleExtra(${idx})">
            <div>
              <div style="font-weight:800">${escapeHtml(e.name)}</div>
              <small>+ ${money(e.price||0)}</small>
            </div>
            <div style="font-size:1.05rem">${on ? "‚úÖ" : "‚¨ú"}</div>
          </div>
        `;
      }).join("");
    }

    function escapeHtml(str){
      return String(str||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ====== send ======
    function sendToCart(){
      if(!product) return;

      // ‚úÖ pacote √∫nico (produto + op√ß√µes)
      const selections = {
        flavor: selectedFlavor ? { name:selectedFlavor.name, price:selectedFlavor.price } : null,
        size: selectedSize ? { name:selectedSize.name, price:selectedSize.price } : null,
        extras: (selectedExtras||[]).map(x=>({name:x.name,price:x.price}))
      };

      window.parent?.postMessage({
        type: "ADD_TO_CART",
        payload: { productId: product.id, qty, selections }
      }, "*");

      toast("Adicionado!");
      setTimeout(closeMe, 250);
    }

    // ====== load ======
    async function load(){
      if(!storeId || !productId){
        document.getElementById("pImg").innerHTML = `<div style="color:var(--muted)">Erro: IDs ausentes</div>`;
        return;
      }
      try{
        const doc = await db.collection("products").doc(productId).get();
        if(!doc.exists){
          document.getElementById("pImg").innerHTML = `<div style="color:var(--muted)">Produto n√£o encontrado</div>`;
          return;
        }
        product = { id: doc.id, ...doc.data() };
        renderProduct();
      }catch(e){
        console.error(e);
        document.getElementById("pImg").innerHTML = `<div style="color:var(--muted)">Erro ao carregar</div>`;
      }
    }

    load();
  </script>
</body>
</html>
