<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pedrad - Delivery</title>
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="client-review-modal.css">
    
    <style>

        /* Esconder a tela de login *\
        body:not(.auth-ready) #authPage,
body:not(.auth-ready) #mainApp {
    opacity: 0;
    pointer-events: none;
}

/* Loading */
.auth-loading {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    z-index: 9999;
}

body.auth-ready .auth-loading {
    display: none;
}

/* Transi√ß√£o suave */
#authPage,
#mainApp {
    transition: opacity 0.3s ease;
}
        /* CSS adicional para bot√£o de avalia√ß√µes pendentes */
        .profile-menu-content {
            flex: 1;
        }
        
        .profile-menu-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 2px;
        }
        
        .profile-menu-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        .profile-menu-badge {
            min-width: 24px;
            height: 24px;
            background: var(--primary);
            color: #000;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
        }
        
        .profile-menu-badge:empty {
            display: none;
        }
        
        /* FIX: Limita scroll das p√°ginas */
        .page {
            overflow-y: auto !important;
            overflow-x: hidden !important;
            max-height: calc(100vh - 120px) !important;
            -webkit-overflow-scrolling: touch;
        }
        
        /* FIX: Garante que profile-menu √© vis√≠vel */
        .profile-menu {
            display: flex !important;
            flex-direction: column !important;
            gap: 0 !important;
        }
        
        .profile-menu-item {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
    </style>
</head>
<body>
      

    <div class="offline-banner" id="offlineBanner">Voc√™ est√° offline</div>
    <div class="toast" id="toast"></div>
    
    <!-- Auth Page -->
    <div id="authPage" class="auth-container">
        <div class="auth-logo">
            <h1>Pedra Delivery</h1>
            <p>Delivery</p>
        </div>
        
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">Entrar</button>
            <button class="auth-tab" onclick="switchAuthTab('register')">Criar conta</button>
        </div>
        
        <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
            <div class="input-group">
                <label>E-mail</label>
                <input type="email" class="input" id="loginEmail" placeholder="seu@email.com" required>
            </div>
            <div class="input-group">
                <label>Senha</label>
                <input type="password" class="input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <button type="submit" class="btn btn-primary">Entrar</button>
        </form>
        
        <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
            <div class="input-group">
                <label>Nome completo</label>
                <input type="text" class="input" id="registerName" placeholder="Seu nome" required>
            </div>
            <div class="input-group">
                <label>E-mail</label>
                <input type="email" class="input" id="registerEmail" placeholder="seu@email.com" required>
            </div>
            <div class="input-group">
                <label>Telefone</label>
                <input type="tel" class="input" id="registerPhone" placeholder="(00) 00000-0000" required>
            </div>
            <div class="input-group">
                <label>Senha</label>
                <input type="password" class="input" id="registerPassword" placeholder="M√≠nimo 6 caracteres" required minlength="6">
            </div>
            <button type="submit" class="btn btn-primary">Criar conta</button>
        </form>
    </div>
    
    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <header class="header">
            <div class="header-title">PEDRA DELIVERY</div>
            <div class="header-actions">
                <button class="header-btn" onclick="showPage('cart')">
                    ‚óé
                    <span class="cart-badge" id="cartBadge"></span>
                </button>
                <button class="header-btn notification-badge-btn" id="notificationBadge" onclick="openNotifications()">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M18 16V11a6 6 0 1 0-12 0v5l-2 2h16l-2-2Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                        <path d="M12 22a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2Z" fill="currentColor"/>
                    </svg>
                    <span class="notification-badge-count" id="notificationBadgeCount"></span>
                </button>
            </div>
        </header>
        
        <!-- Notifications Page -->
        <div id="notificationsPage" class="page">
            <h2 style="margin-bottom:24px;font-weight:400;letter-spacing:1px;">Notifica√ß√µes</h2>
            <div id="notificationsList"></div>
            <button class="btn btn-secondary" onclick="NotificationSync.clearAll(); NotificationSync.renderHistory('notificationsList')">
                Limpar tudo
            </button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">            
            <div id="storeSelection">
                <h2 style="margin-bottom: 8px; font-weight: 400; letter-spacing: 1px;">Escolha uma loja</h2>
                <p style="color: var(--text-muted); margin-bottom: 24px; font-size: 0.85rem;">Selecione onde voc√™ quer pedir</p>
                
                <!-- Filtros -->
                <div id="storeFilters"></div>
                
                <div id="storesGrid" class="stores-grid"></div>
            </div>
            
            <div id="storeMenu" style="display: none;">
                <div class="store-header-bar" onclick="backToStores()">
                    <span class="back-btn">‚Üê</span>
                    <div class="store-header-info">
                        <span class="store-header-name" id="selectedStoreName">Loja</span>
                        <span class="store-header-status" id="selectedStoreStatus">Aberto</span>
                    </div>
                </div>
                
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Buscar produtos..." id="searchInput" oninput="filterProducts()">
                </div>
                
                <div class="categories" id="categoriesContainer"></div>
                <div class="products-grid" id="productsGrid"></div>
            </div>
        </div>
        
        <!-- Cart Page -->
        <div id="cartPage" class="page">
            <h2 style="margin-bottom: 24px; font-weight: 400; letter-spacing: 1px;">Carrinho</h2>
            <div id="cartItems"></div>
            <div id="cartSummary" style="display: none;">
                <div class="card" style="margin-top: 16px;">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="cartSubtotal">R$ 0,00</span>
                    </div>
                    <div class="summary-row" id="cartDiscountRow" style="display:none; color: var(--primary);">
                        <span>Desconto</span>
                        <span id="cartDiscount">- R$ 0,00</span>
                    </div>
                    <div class="summary-row">
                        <span>Taxa de entrega</span>
                        <span id="cartDelivery">R$ 0,00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="cartTotal">R$ 0,00</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="showCheckout()" style="margin-top: 16px;">
                    Finalizar pedido
                </button>
            </div>
        </div>
        
        <!-- Orders Page -->
        <div id="ordersPage" class="page">
            <h2 style="margin-bottom: 24px; font-weight: 400; letter-spacing: 1px;">Meus Pedidos</h2>
            <div id="ordersList"></div>
        </div>
        
        <!-- Profile Page -->
        <div id="profilePage" class="page">
            <div class="profile-header">
                <div id="profileAvatarContainer"></div>
                <div class="profile-name" id="profileName">-</div>
                <div class="profile-email" id="profileEmail">-</div>
            </div>
            
            <div class="profile-menu">
                <!-- BOT√ÉO DE AVALIA√á√ïES (COM !important PARA GARANTIR) -->
                <div class="profile-menu-item" 
                     onclick="window.location.href='pending-reviews.html'" 
                     style="display:flex !important;align-items:center;gap:12px;padding:16px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;cursor:pointer;margin-bottom:12px;opacity:1 !important;visibility:visible !important;">
                    
                    <div style="font-size:1.3rem;width:40px;height:40px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.05);border-radius:10px;">
                        ‚≠ê
                    </div>
                    
                    <div style="flex:1;">
                        <div style="font-weight:600;font-size:0.95rem;margin-bottom:2px;">
                            Avalia√ß√µes Pendentes
                        </div>
                        <div style="font-size:0.75rem;color:var(--text-muted);">
                            Avalie seus pedidos entregues
                        </div>
                    </div>
                    
                    <div id="pendingReviewsBadge" style="min-width:24px;height:24px;background:var(--primary);color:#000;border-radius:12px;font-size:0.75rem;font-weight:600;display:none;align-items:center;justify-content:center;padding:0 8px;">
                    </div>
                    
                    <div style="font-size:1.2rem;color:var(--text-muted);">‚Ä∫</div>
                </div>
                
                <!-- OUTROS BOT√ïES DO MENU -->
                <div class="profile-menu-item" onclick="showPage('addresses')">
                    <div class="profile-menu-icon">‚óé</div>
                    <div class="profile-menu-text">Meus endere√ßos</div>
                    <div class="profile-menu-arrow">‚Ä∫</div>
                </div>
                
                <div class="profile-menu-item" onclick="showPage('orders')">
                    <div class="profile-menu-icon">‚â°</div>
                    <div class="profile-menu-text">Hist√≥rico de pedidos</div>
                    <div class="profile-menu-arrow">‚Ä∫</div>
                </div>
                
                <div class="profile-menu-item" onclick="handleLogout()">
                    <div class="profile-menu-icon">‚Üí</div>
                    <div class="profile-menu-text" style="color: var(--text-muted);">Sair</div>
                    <div class="profile-menu-arrow">‚Ä∫</div>
                </div>
            </div>
        </div>
        
        <!-- Addresses Page -->
        <div id="addressesPage" class="page">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
                <span style="font-size: 1.3rem; cursor: pointer;" onclick="showPage('profile')">‚Üê</span>
                <h2 style="font-weight: 400; letter-spacing: 1px;">Meus Endere√ßos</h2>
            </div>
            <div id="addressesList"></div>
            <button class="btn btn-primary" onclick="showAddAddressModal()" style="margin-top: 16px;">
                + Adicionar endere√ßo
            </button>
        </div>
        
        <!-- Tracking Page -->
        <div id="trackingPage" class="page"></div>
        
        <!-- Navigation -->
        <nav class="nav">
            <div class="nav-item active" onclick="showPage('home')">
                <span>‚åÇ</span>
                In√≠cio
            </div>
            <div class="nav-item" onclick="showPage('orders')">
                <span>‚â°</span>
                Pedidos
            </div>
            <div class="nav-item" onclick="showPage('profile')">
                <span>‚óã</span>
                Perfil
            </div>
        </nav>
    </div>
    
    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="product-detail-img" id="modalProductImg">‚óé</div>
            <div class="product-detail-info">
                <div class="product-detail-name" id="modalProductName">-</div>
                <div class="product-detail-desc" id="modalProductDesc">-</div>
                <div class="product-detail-price" id="modalProductPrice">R$ 0,00</div>
                
                <div class="product-qty-selector">
                    <button class="product-qty-btn" onclick="changeModalQty(-1)">‚àí</button>
                    <span class="product-qty-value" id="modalQty">1</span>
                    <button class="product-qty-btn" onclick="changeModalQty(1)">+</button>
                </div>
                
                <button class="btn btn-primary" onclick="addToCartFromModal()">Adicionar ao carrinho</button>
                <button class="btn btn-secondary" onclick="closeModal('productModal')" style="margin-top: 8px;">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Finalizar Pedido</div>
                <button class="modal-close" onclick="closeModal('checkoutModal')">√ó</button>
            </div>
            <div class="modal-body">
                <h3 style="margin-bottom: 12px; font-weight: 400; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Tipo de pedido</h3>
                <div class="delivery-mode-selector" style="display:flex;gap:8px;margin-bottom:24px;">
                    <div class="mode-option selected" id="modeDelivery" onclick="setDeliveryMode('delivery')">
                        <span>üõµ</span> Entrega
                    </div>
                    <div class="mode-option" id="modePickup" onclick="setDeliveryMode('pickup')">
                        <span>üè™</span> Retirar na Loja
                    </div>
                </div>

                <div id="addressSection">
                    <h3 style="margin-bottom: 12px; font-weight: 400; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Endere√ßo de entrega</h3>
                    <div id="checkoutAddresses"></div>
                    <button class="btn btn-secondary btn-sm" onclick="showAddAddressModal()" style="margin-bottom: 24px;">
                        + Adicionar novo endere√ßo
                    </button>
                </div>

                <h3 style="margin-bottom: 12px; font-weight: 400; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Cupom de desconto</h3>
                <div class="coupon-box">
                    <input type="text" class="input" id="couponInput" placeholder="Digite o c√≥digo">
                    <button class="btn btn-secondary btn-sm" onclick="applyCoupon()">Aplicar</button>
                </div>
                <div id="couponStatus" class="coupon-status"></div>

                <h3 style="margin-bottom: 12px; font-weight: 400; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Forma de pagamento</h3>
                <div class="payment-options" id="paymentOptions">
                    <label class="payment-option selected">
                        <input type="radio" name="payment" value="pix" checked onchange="selectPayment(this)">
                        <span class="payment-icon">‚óâ</span>
                        <span class="payment-info"><span class="payment-name">PIX</span><span class="payment-desc">Pagamento instant√¢neo</span></span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment" value="credit" onchange="selectPayment(this)">
                        <span class="payment-icon">üí≥</span>
                        <span class="payment-info"><span class="payment-name">Cr√©dito</span><span class="payment-desc">Cart√£o de cr√©dito</span></span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment" value="debit" onchange="selectPayment(this)">
                        <span class="payment-icon">üí≥</span>
                        <span class="payment-info"><span class="payment-name">D√©bito</span><span class="payment-desc">Cart√£o de d√©bito</span></span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment" value="cash" onchange="selectPayment(this)">
                        <span class="payment-icon">üíµ</span>
                        <span class="payment-info"><span class="payment-name">Dinheiro</span><span class="payment-desc">Pagar na entrega/retirada</span></span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment" value="picpay" onchange="selectPayment(this)">
                        <span class="payment-icon">üì±</span>
                        <span class="payment-info"><span class="payment-name">PicPay</span><span class="payment-desc">Carteira digital</span></span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment" value="alimentacao" onchange="selectPayment(this)">
                        <span class="payment-icon">üçΩÔ∏è</span>
                        <span class="payment-info"><span class="payment-name">Alimenta√ß√£o</span><span class="payment-desc">Vale alimenta√ß√£o/refei√ß√£o</span></span>
                    </label>
                </div>

                <div class="card">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="checkoutSubtotal">R$ 0,00</span>
                    </div>
                    <div class="summary-row" id="checkoutDiscountRow" style="display:none; color: var(--primary);">
                        <span>Desconto</span>
                        <span id="checkoutDiscount">- R$ 0,00</span>
                    </div>
                    <div class="summary-row" id="checkoutDeliveryRow">
                        <span>Entrega (<span id="checkoutNeighborhood">-</span>)</span>
                        <span id="checkoutDelivery">R$ 0,00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="checkoutTotal">R$ 0,00</span>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="submitOrder()" style="margin-top: 16px;">
                    Confirmar pedido
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Address Modal -->
    <div class="modal" id="addressModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Novo Endere√ßo</div>
                <button class="modal-close" onclick="closeModal('addressModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveAddress(event)">
                    <div class="input-group">
                        <label>Apelido (ex: Casa, Trabalho)</label>
                        <input type="text" class="input" id="addressLabel" placeholder="Casa" required>
                    </div>
                    <div class="input-group">
                        <label>Rua</label>
                        <input type="text" class="input" id="addressStreet" placeholder="Nome da rua" required>
                    </div>
                    <div class="input-group">
                        <label>N√∫mero</label>
                        <input type="text" class="input" id="addressNumber" placeholder="123" required>
                    </div>
                    <div class="input-group">
                        <label>Complemento</label>
                        <input type="text" class="input" id="addressComplement" placeholder="Apto, Bloco...">
                    </div>
                    <div class="input-group">
                        <label>Bairro</label>
                        <select class="input" id="addressNeighborhood" required>
                            <option value="">Selecione o bairro</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Ponto de refer√™ncia</label>
                        <input type="text" class="input" id="addressReference" placeholder="Pr√≥ximo a...">
                    </div>
                    
                    <div class="location-box" id="addressLocationBox">
                        <div class="location-status" id="addressLocationStatus">
                            <span class="location-icon">‚óé</span>
                            <span>Localiza√ß√£o n√£o capturada</span>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:12px;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="captureAddressLocation()" style="flex:1;">GPS autom√°tico</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="openMapPicker()" style="flex:1;">Escolher no mapa</button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Salvar endere√ßo</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Order Detail Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Detalhes do Pedido</div>
                <button class="modal-close" onclick="closeModal('orderModal')">√ó</button>
            </div>
            <div class="modal-body" id="orderDetailContent"></div>
        </div>
    </div>
    
    <!-- Scripts do Firebase e m√≥dulos -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="modules/stores.js"></script>
    <script src="modules/profile.js"></script>
    <script src="modules/notifications.js"></script>
    <script src="modules/tracking.js"></script>
    <script src="modules/store-cache.js"></script>
    <script src="index.js"></script>
    
    <!-- SCRIPT DE AVALIA√á√ïES - DEVE VIR DEPOIS DO INDEX.JS -->
    <script>
    window.addEventListener('load', function() {
        console.log('üîß Inicializando sistema de avalia√ß√µes pendentes...');
        
        window.updatePendingReviewsBadge = async function() {
            if (!window.currentUser) {
                console.log('‚ö†Ô∏è currentUser ainda n√£o dispon√≠vel');
                return;
            }
            
            try {
                const snapshot = await db.collection('orders')
                    .where('userId', '==', window.currentUser.uid)
                    .where('status', '==', 'delivered')
                    .where('reviewed', '==', false)
                    .get();
                
                const count = snapshot.size;
                const badge = document.getElementById('pendingReviewsBadge');
                
                if (badge) {
                    badge.textContent = count;
                    badge.style.display = count > 0 ? 'flex' : 'none';
                    console.log(`‚úÖ Badge atualizado: ${count} avalia√ß√µes pendentes`);
                } else {
                    console.error('‚ùå Badge n√£o encontrado no DOM');
                }
                
            } catch (err) {
                console.error('‚ùå Erro ao contar avalia√ß√µes pendentes:', err);
            }
        };
        
        const _originalShowPage = window.showPage;
        
        if (typeof _originalShowPage === 'function') {
            window.showPage = function(pageId) {
                _originalShowPage(pageId);
                
                if (pageId === 'profile' && window.currentUser) {
                    setTimeout(window.updatePendingReviewsBadge, 500);
                }
            };
            
            console.log('‚úÖ showPage interceptado com sucesso');
        } else {
            console.error('‚ùå showPage n√£o est√° definido. Tentando novamente em 1s...');
            setTimeout(arguments.callee, 1000);
            return;
        }
        
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && window.currentUser) {
                const profilePage = document.getElementById('profilePage');
                if (profilePage && profilePage.classList.contains('active')) {
                    window.updatePendingReviewsBadge();
                }
            }
        });
        
        console.log('‚úÖ Sistema de avalia√ß√µes inicializado');
    });
    </script>
    <script src="modules/polish.js"></script>
    <script src="modules/orders-lazy-loading.js"></script>
</body>
</html>
