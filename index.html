<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pedrad - Delivery</title>
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="client-review-modal.css">
    <style>
        /* Esconde tudo at√© decidir qual tela mostrar */
        #authPage, #mainApp { display: none; }
        
        /* Loading inicial */
        .app-loading {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        .app-loading.hide { opacity: 0; pointer-events: none; }
        .app-loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid #262626;
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .product-img img { width:100%; height:100%; object-fit:cover; display:block; }
        .main { padding-top: 70px; padding-bottom: 80px; }
        .page { overflow-y: auto !important; overflow-x: hidden !important; max-height: calc(100vh - 120px) !important; -webkit-overflow-scrolling: touch; }
        .profile-menu { display: flex !important; flex-direction: column !important; }
        .profile-menu-item { display: flex !important; opacity: 1 !important; visibility: visible !important; }
    </style>
    <script>
        // Decide UI inicial ANTES de carregar Firebase
        (function() {
            var hasSession = localStorage.getItem('auth_uid');
            var lastCheck = parseInt(localStorage.getItem('auth_last_check') || '0');
            var isRecent = Date.now() - lastCheck < 24 * 60 * 60 * 1000;
            
            // Define qual mostrar ap√≥s DOMContentLoaded
            window._showAuth = !(hasSession && isRecent);
        })();
    </script>
</head>
<body>
    <!-- Loading inicial -->
    <div class="app-loading" id="appLoading">
        <div class="app-loading-spinner"></div>
    </div>

    <div class="offline-banner" id="offlineBanner">Voc√™ est√° offline</div>
    <div class="toast" id="toast"></div>
    
    <!-- Auth Page -->
    <div id="authPage" class="auth-container">
        <div class="auth-logo">
            <h1>Pedra Delivery</h1>
            <p>Delivery</p>
        </div>
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">Entrar</button>
            <button class="auth-tab" onclick="switchAuthTab('register')">Criar conta</button>
        </div>
        <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
            <div class="input-group">
                <label>E-mail</label>
                <input type="email" class="input" id="loginEmail" placeholder="seu@email.com" required>
            </div>
            <div class="input-group">
                <label>Senha</label>
                <input type="password" class="input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>
            <button type="submit" class="btn btn-primary">Entrar</button>
        </form>
        <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
            <div class="input-group">
                <label>Nome completo</label>
                <input type="text" class="input" id="registerName" placeholder="Seu nome" required>
            </div>
            <div class="input-group">
                <label>E-mail</label>
                <input type="email" class="input" id="registerEmail" placeholder="seu@email.com" required>
            </div>
            <div class="input-group">
                <label>Telefone</label>
                <input type="tel" class="input" id="registerPhone" placeholder="(00) 00000-0000" required>
            </div>
            <div class="input-group">
                <label>Senha</label>
                <input type="password" class="input" id="registerPassword" placeholder="M√≠nimo 6 caracteres" required minlength="6">
            </div>
            <button type="submit" class="btn btn-primary">Criar conta</button>
        </form>
    </div>
    
    <!-- Main App -->
    <div id="mainApp">
        <header class="header">
            <div class="header-title">PEDRA DELIVERY</div>
            <div class="header-actions">
                <button class="header-btn" onclick="showPage('cart')">
                    ‚óé
                    <span class="cart-badge" id="cartBadge"></span>
                </button>
                <button class="header-btn notification-badge-btn" id="notificationBadge" onclick="openNotifications()">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M18 16V11a6 6 0 1 0-12 0v5l-2 2h16l-2-2Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
                        <path d="M12 22a2 2 0 0 0 2-2H10a2 2 0 0 0 2 2Z" fill="currentColor"/>
                    </svg>
                    <span class="notification-badge-count" id="notificationBadgeCount"></span>
                </button>
            </div>
        </header>
        
        <!-- Notifications Page -->
        <div id="notificationsPage" class="page">
            <h2 style="margin-bottom:24px;font-weight:400;letter-spacing:1px;">Notifica√ß√µes</h2>
            <div id="notificationsList"></div>
            <button class="btn btn-secondary" onclick="NotificationSync.clearAll();NotificationSync.renderHistory('notificationsList')">Limpar tudo</button>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">            
            <div id="storeSelection">
                <h2 style="margin-bottom:8px;font-weight:400;letter-spacing:1px;">Escolha uma loja</h2>
                <p style="color:var(--text-muted);margin-bottom:24px;font-size:0.85rem;">Selecione onde voc√™ quer pedir</p>
                <div id="storeFilters"></div>
                <div id="storesGrid" class="stores-grid"></div>
            </div>
            
            <div id="storeMenu" style="display:none;">
                <div class="store-header-bar" onclick="backToStores()">
                    <span class="back-btn">‚Üê</span>
                    <div class="store-header-info">
                        <span class="store-header-name" id="selectedStoreName">Loja</span>
                        <span class="store-header-status" id="selectedStoreStatus">Aberto</span>
                    </div>
                </div>
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Buscar produtos..." id="searchInput" oninput="filterProducts()">
                </div>
                <div class="categories" id="categoriesContainer"></div>
                <div class="products-grid" id="productsGrid"></div>
            </div>
        </div>
        
        <!-- Cart Page -->
        <div id="cartPage" class="page">
            <h2 style="margin-bottom:24px;font-weight:400;letter-spacing:1px;">Carrinho</h2>
            <div id="cartItems"></div>
            <div id="cartSummary" style="display:none;">
                <div class="card" style="margin-top:16px;">
                    <div class="summary-row"><span>Subtotal</span><span id="cartSubtotal">R$ 0,00</span></div>
                    <div class="summary-row" id="cartDiscountRow" style="display:none;color:var(--primary);"><span>Desconto</span><span id="cartDiscount">- R$ 0,00</span></div>
                    <div class="summary-row"><span>Taxa de entrega</span><span id="cartDelivery">R$ 0,00</span></div>
                    <div class="summary-row total"><span>Total</span><span id="cartTotal">R$ 0,00</span></div>
                </div>
                <button class="btn btn-primary" onclick="window.location.href='checkout.html'" style="margin-top:16px;">Finalizar pedido</button>
            </div>
        </div>
        
        <!-- Orders Page -->
        <div id="ordersPage" class="page">
            <h2 style="margin-bottom:24px;font-weight:400;letter-spacing:1px;">Meus Pedidos</h2>
            <div id="ordersList"></div>
        </div>
        
        <!-- Tracking Page -->
        <div id="trackingPage" class="page"></div>

        <!-- Navigation -->
        <nav class="nav">
            <div class="nav-item active" onclick="showPage('home')"><span>‚åÇ</span>In√≠cio</div>
            <div class="nav-item" onclick="window.location.href='orders.html'"><span>‚â°</span>Pedidos</div>
            <div class="nav-item" onclick="window.location.href='profile.html'"><span>‚óã</span>Perfil</div>
        </nav>
    </div>
    
    <!-- Product Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalProductName">Produto</div>
                <button class="modal-close" onclick="closeModal('productModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="product-modal-img" id="modalProductImg">üçΩÔ∏è</div>
                <p class="product-modal-desc" id="modalProductDesc"></p>
                <div id="modalAddons"></div>
                <div class="product-modal-footer">
                    <div class="qty-control">
                        <button class="qty-btn" onclick="changeModalQty(-1)">‚àí</button>
                        <span class="qty-value" id="modalQty">1</span>
                        <button class="qty-btn" onclick="changeModalQty(1)">+</button>
                    </div>
                    <div class="product-modal-price" id="modalProductPrice">R$ 0,00</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" style="width:100%" onclick="addToCartFromModal()">Adicionar ao carrinho</button>
            </div>
        </div>
    </div>
    
    <!-- Checkout Modal -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Finalizar Pedido</div>
                <button class="modal-close" onclick="closeModal('checkoutModal')">√ó</button>
            </div>
            <div class="modal-body">
                <h3 style="margin-bottom:12px;font-weight:400;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px;">Tipo de pedido</h3>
                <div class="delivery-mode-selector" style="display:flex;gap:8px;margin-bottom:24px;">
                    <div class="mode-option selected" id="modeDelivery" onclick="setDeliveryMode('delivery')"><span>üõµ</span> Entrega</div>
                    <div class="mode-option" id="modePickup" onclick="setDeliveryMode('pickup')"><span>üè™</span> Retirar</div>
                </div>
                <div id="addressSection">
                    <h3 style="margin-bottom:12px;font-weight:400;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px;">Endere√ßo</h3>
                    <div id="checkoutAddresses"></div>
                    <button class="btn btn-secondary btn-sm" onclick="showAddAddressModal()" style="margin-bottom:24px;">+ Novo endere√ßo</button>
                </div>
                <h3 style="margin-bottom:12px;font-weight:400;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px;">Cupom</h3>
                <div class="coupon-box">
                    <input type="text" class="input" id="couponInput" placeholder="C√≥digo">
                    <button class="btn btn-secondary btn-sm" onclick="applyCoupon()">Aplicar</button>
                </div>
                <div id="couponStatus" class="coupon-status"></div>
                <h3 style="margin-bottom:12px;font-weight:400;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px;">Pagamento</h3>
                <div class="payment-options" id="paymentOptions">
                    <label class="payment-option selected"><input type="radio" name="payment" value="pix" checked onchange="selectPayment(this)"><span class="payment-icon">‚óâ</span><span class="payment-info"><span class="payment-name">PIX</span></span></label>
                    <label class="payment-option"><input type="radio" name="payment" value="credit" onchange="selectPayment(this)"><span class="payment-icon">üí≥</span><span class="payment-info"><span class="payment-name">Cr√©dito</span></span></label>
                    <label class="payment-option"><input type="radio" name="payment" value="debit" onchange="selectPayment(this)"><span class="payment-icon">üí≥</span><span class="payment-info"><span class="payment-name">D√©bito</span></span></label>
                    <label class="payment-option"><input type="radio" name="payment" value="cash" onchange="selectPayment(this)"><span class="payment-icon">üíµ</span><span class="payment-info"><span class="payment-name">Dinheiro</span></span></label>
                </div>
                <div class="card">
                    <div class="summary-row"><span>Subtotal</span><span id="checkoutSubtotal">R$ 0,00</span></div>
                    <div class="summary-row" id="checkoutDiscountRow" style="display:none;color:var(--primary);"><span>Desconto</span><span id="checkoutDiscount">- R$ 0,00</span></div>
                    <div class="summary-row" id="checkoutDeliveryRow"><span>Entrega (<span id="checkoutNeighborhood">-</span>)</span><span id="checkoutDelivery">R$ 0,00</span></div>
                    <div class="summary-row total"><span>Total</span><span id="checkoutTotal">R$ 0,00</span></div>
                </div>
                <button class="btn btn-primary" onclick="submitOrder()" style="margin-top:16px;">Confirmar pedido</button>
            </div>
        </div>
    </div>
    
    <!-- Address Modal -->
    <div class="modal" id="addressModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Novo Endere√ßo</div>
                <button class="modal-close" onclick="closeModal('addressModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form onsubmit="saveAddress(event)">
                    <div class="input-group"><label>Apelido</label><input type="text" class="input" id="addressLabel" placeholder="Casa" required></div>
                    <div class="input-group"><label>Rua</label><input type="text" class="input" id="addressStreet" required></div>
                    <div class="input-group"><label>N√∫mero</label><input type="text" class="input" id="addressNumber" required></div>
                    <div class="input-group"><label>Complemento</label><input type="text" class="input" id="addressComplement"></div>
                    <div class="input-group"><label>Bairro</label><select class="input" id="addressNeighborhood" required><option value="">Selecione</option></select></div>
                    <div class="input-group"><label>Refer√™ncia</label><input type="text" class="input" id="addressReference"></div>
                    <div class="location-box" id="addressLocationBox">
                        <div class="location-status" id="addressLocationStatus"><span>üìç</span><span>Localiza√ß√£o n√£o capturada</span></div>
                        <div style="display:flex;gap:8px;margin-top:12px;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="captureAddressLocation()" style="flex:1;">GPS</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="openMapPicker()" style="flex:1;">Mapa</button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Order Detail Modal -->
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Detalhes do Pedido</div>
                <button class="modal-close" onclick="closeModal('orderModal')">√ó</button>
            </div>
            <div class="modal-body" id="orderDetailContent"></div>
        </div>
    </div>
    
    <!-- Product Popup -->
    <div id="htmlPopup" style="display:none;position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.6)">
        <div style="width:min(520px,92vw);height:min(820px,92vh);margin:4vh auto;background:#0a0a0a;border:1px solid #262626;border-radius:14px;overflow:hidden">
            <iframe id="popupFrame" style="width:100%;height:100%;border:0" onerror="window.location.href='404.html?auto=1'"></iframe>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- M√≥dulos otimizados -->
    <script src="modules/image-helper.js"></script>
    <script src="modules/data-cache.js"></script>
    <script src="modules/auth-manager.js"></script>
    <script src="modules/user-metrics.js"></script>
    
    <!-- App principal -->
    <script src="index.js"></script>
    <script src="modules/stores.js"></script>
    <script src="modules/notifications.js"></script>
    <script src="modules/notSync.js"></script>
<script src="modules/checker.js"></script>
    <script src="modules/fcm.js"></script>
    <script src="modules/tracking.js"></script>
    <script src="modules/store-cache.js"></script>
    <script src="modules/polish.js"></script>
   <script src="modules/welcome-popup.js"></script>
    
    <script>
        // Mostra UI correta imediatamente
        document.addEventListener('DOMContentLoaded', function() {
            var authPage = document.getElementById('authPage');
            var mainApp = document.getElementById('mainApp');
            var loading = document.getElementById('appLoading');
            
            if (window._showAuth) {
                authPage.style.display = 'flex';
                mainApp.style.display = 'none';
            } else {
                authPage.style.display = 'none';
                mainApp.style.display = 'block';
            }
            
            // Remove loading ap√≥s breve delay
            setTimeout(function() {
                loading.classList.add('hide');
                setTimeout(function() { loading.remove(); }, 300);
            }, 200);
        });
        
        // Popup message handler
        window.addEventListener("message", function(ev) {
            if (!ev.data) return;
            if (ev.data.type === "closePopup") {
                document.getElementById("htmlPopup").style.display = "none";
                document.getElementById("popupFrame").src = "about:blank";
            }
            if (ev.data.type === "cartUpdated") {
                if (typeof loadCart === 'function') loadCart();
                if (typeof renderCart === 'function') renderCart();
                if (typeof updateCartBadge === 'function') updateCartBadge();
            }
        });
        
        // Inicializa√ß√£o de lojas ap√≥s auth

window.addEventListener("load", async () => {
  const tryWelcome = () => {
    if (typeof WelcomePopup !== "undefined" && typeof WelcomePopup.check === "function") {
      WelcomePopup.check();
    }
  };

  if (typeof firebase === "undefined" || !firebase.auth) {
    tryWelcome();
    return;
  }

  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) return;

    if (typeof loadStores === "function") await loadStores();

    if (typeof StoresModule !== "undefined" && typeof StoresModule.render === "function") {
      StoresModule.render();
    }

    tryWelcome();
  });
});
</script>

    
    <script src="modules/search.js"></script>
</body>
</html>
