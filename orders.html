<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Meus Pedidos - Pedrad</title>
  <meta name="theme-color" content="#000000">
  <style>
    :root {
      --bg: #000; --bg-card: #0a0a0a; --bg-input: #111;
      --border: #262626; --text: #fafafa; --text-muted: #737373;
      --primary: #fff; --danger: #ef4444; --success: #22c55e;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text); min-height: 100vh;
    }

    /* Header */
    .header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      height: 64px; background: var(--bg);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
      padding: 0 16px; padding-top: env(safe-area-inset-top);
    }
    .btn-back {
      width: 44px; height: 44px; border-radius: 12px;
      background: var(--bg-input); border: 1px solid var(--border);
      color: var(--text); font-size: 1.1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .header-title { flex: 1; font-size: 1rem; font-weight: 700; letter-spacing: 1px; }
    .header-badge {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 20px; padding: 6px 12px; font-size: .75rem;
      color: var(--text-muted);
    }
    .btn-refresh {
      width: 44px; height: 44px; border-radius: 12px;
      background: var(--bg-input); border: 1px solid var(--border);
      color: var(--text); font-size: 1.1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }

    /* Container */
    .container {
      max-width: 600px; margin: 0 auto;
      padding: 84px 16px 100px;
    }

    /* Stats */
    .stats {
      display: flex; gap: 10px; margin-bottom: 16px;
    }
    .stat {
      flex: 1; background: var(--bg-card);
      border: 1px solid var(--border); border-radius: 12px;
      padding: 14px; text-align: center;
    }
    .stat-value { font-size: 1.5rem; font-weight: 800; }
    .stat-label { font-size: .7rem; color: var(--text-muted); margin-top: 2px; }

    /* Actions */
    .actions {
      display: flex; gap: 10px; margin-bottom: 16px;
    }
    .btn-action {
      flex: 1; padding: 12px; border-radius: 12px;
      border: 1px solid var(--border); background: var(--bg-card);
      color: var(--text); font-size: .85rem; font-weight: 600;
      cursor: pointer; transition: all .2s;
    }
    .btn-action:hover { border-color: var(--primary); }
    .btn-action:disabled { opacity: .4; cursor: not-allowed; }
    .btn-action.danger { color: var(--danger); border-color: rgba(239,68,68,.3); }
    .btn-action.danger:hover { background: rgba(239,68,68,.1); }
    .btn-action.active { background: var(--primary); color: #000; border-color: transparent; }

    /* Filter Tabs */
    .tabs {
      display: flex; gap: 8px; margin-bottom: 16px;
      overflow-x: auto; padding-bottom: 4px;
    }
    .tab {
      padding: 10px 16px; border-radius: 20px;
      border: 1px solid var(--border); background: var(--bg-card);
      color: var(--text-muted); font-size: .8rem; font-weight: 600;
      cursor: pointer; white-space: nowrap; transition: all .2s;
    }
    .tab:hover { border-color: var(--text-muted); }
    .tab.active { background: var(--primary); color: #000; border-color: transparent; }

    /* Orders List */
    .orders-list { display: flex; flex-direction: column; gap: 12px; }

    /* Order Card */
    .order-card {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 16px; overflow: hidden; cursor: pointer;
      transition: all .2s;
    }
    .order-card:hover { border-color: rgba(255,255,255,.2); }
    .order-card.active-order { border-left: 3px solid var(--success); }

    .order-header {
      padding: 14px; display: flex; justify-content: space-between;
      align-items: flex-start; gap: 12px;
    }
    .order-store { font-weight: 700; font-size: 1rem; margin-bottom: 4px; }
    .order-meta { font-size: .8rem; color: var(--text-muted); }
    .order-status {
      padding: 6px 10px; border-radius: 20px; font-size: .75rem;
      font-weight: 600; white-space: nowrap;
    }
    .status-pending { background: rgba(245,158,11,.15); color: #fbbf24; }
    .status-confirmed { background: rgba(59,130,246,.15); color: #60a5fa; }
    .status-preparing { background: rgba(168,85,247,.15); color: #c084fc; }
    .status-ready { background: rgba(34,197,94,.15); color: #4ade80; }
    .status-delivering { background: rgba(34,197,94,.2); color: #22c55e; }
    .status-delivered { background: rgba(255,255,255,.1); color: var(--text-muted); }
    .status-cancelled { background: rgba(239,68,68,.15); color: #f87171; }

    .order-items {
      padding: 0 14px 14px;
      font-size: .85rem; color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }
    .order-footer {
      padding: 12px 14px; display: flex;
      justify-content: space-between; align-items: center;
    }
    .order-total { font-weight: 700; }
    .order-code { font-size: .75rem; color: var(--text-muted); }

    /* Empty State */
    .empty-state {
      text-align: center; padding: 60px 20px;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 16px;
    }
    .empty-icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-title { font-weight: 700; margin-bottom: 8px; }
    .empty-desc { color: var(--text-muted); font-size: .9rem; line-height: 1.5; }

    /* Toast */
    .toast {
      position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card); padding: 14px 24px;
      border-radius: 12px; border: 1px solid var(--border);
      z-index: 1000; opacity: 0; transition: all .3s;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* Modal */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.9); z-index: 9999;
      overflow-y: auto; padding: 20px;
    }
    .modal-overlay.show { display: block; }
    .modal-content {
      max-width: 500px; margin: 40px auto;
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 20px; overflow: hidden;
    }
    .modal-header {
      padding: 20px; border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-title { font-weight: 700; font-size: 1.1rem; }
    .modal-close {
      width: 36px; height: 36px; border-radius: 10px;
      border: 1px solid var(--border); background: var(--bg-input);
      color: var(--text); font-size: 1.2rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .modal-body { padding: 20px; }

    .detail-section { margin-bottom: 20px; }
    .detail-section:last-child { margin-bottom: 0; }
    .detail-title {
      font-size: .75rem; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 1px;
      margin-bottom: 10px; padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }
    .detail-row {
      display: flex; justify-content: space-between;
      padding: 8px 0; font-size: .9rem;
    }
    .detail-row .label { color: var(--text-muted); }
    .detail-row .value { font-weight: 500; text-align: right; }

    .item-row {
      display: flex; justify-content: space-between;
      padding: 8px 0; font-size: .9rem;
      border-bottom: 1px solid rgba(255,255,255,.05);
    }
    .item-row:last-child { border-bottom: none; }
    .item-name { flex: 1; }
    .item-qty { color: var(--text-muted); margin-right: 12px; }
    .item-price { font-weight: 500; }
    .item-addons { font-size: .8rem; color: var(--text-muted); margin-top: 2px; }

    .btn-review {
      width: 100%; padding: 14px; margin-top: 20px;
      border-radius: 12px; border: none;
      background: var(--primary); color: #000;
      font-size: .95rem; font-weight: 700; cursor: pointer;
    }
    .btn-review:disabled { opacity: .5; cursor: not-allowed; }
    .reviewed-badge {
      text-align: center; padding: 14px;
      background: rgba(34,197,94,.1); border-radius: 12px;
      color: var(--success); font-weight: 600; margin-top: 20px;
    }

    /* Cooldown info */
    .cooldown-info {
      background: rgba(245,158,11,.1); border: 1px solid rgba(245,158,11,.3);
      border-radius: 12px; padding: 12px; margin-bottom: 16px;
      font-size: .85rem; color: #fbbf24; text-align: center;
    }

    /* Confirm Popup */
    .popup-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.85); z-index: 99999;
      align-items: center; justify-content: center; padding: 20px;
    }
    .popup-overlay.show { display: flex; }
    .popup-box {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 16px; max-width: 360px; width: 100%; overflow: hidden;
    }
    .popup-header { padding: 24px 20px 0; text-align: center; }
    .popup-icon { font-size: 3rem; margin-bottom: 12px; }
    .popup-title { font-size: 1.1rem; font-weight: 700; }
    .popup-message {
      padding: 12px 20px 24px; text-align: center;
      color: var(--text-muted); font-size: .9rem; line-height: 1.5;
    }
    .popup-actions { display: flex; border-top: 1px solid var(--border); }
    .popup-btn {
      flex: 1; padding: 16px; border: none; background: transparent;
      color: var(--text); font-size: .95rem; cursor: pointer;
    }
    .popup-btn:hover { background: rgba(255,255,255,.05); }
    .popup-btn.cancel { color: var(--text-muted); }
    .popup-btn.danger { color: var(--danger); font-weight: 600; }
    .popup-btn.primary { color: var(--primary); font-weight: 600; }
    .popup-btn + .popup-btn { border-left: 1px solid var(--border); }
  </style>
</head>
<body>
  <header class="header">
    <button class="btn-back" onclick="goBack()">‚Üê</button>
    <div class="header-title">Meus Pedidos</div>
    <span class="header-badge" id="headerBadge">0 pedidos</span>
    <button class="btn-refresh" onclick="refreshOrders()" title="Atualizar">‚ü≥</button>
  </header>

  <div class="container">
    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="statActive">0</div>
        <div class="stat-label">Em andamento</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="statDelivered">0</div>
        <div class="stat-label">Entregues</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-label">Total</div>
      </div>
    </div>

    <!-- Cooldown Info -->
    <div class="cooldown-info" id="cooldownInfo" style="display:none;">
      ‚è≥ Pr√≥xima restaura√ß√£o dispon√≠vel em <span id="cooldownTime">--</span>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn-action" id="btnRestore" onclick="restoreOrders()">
        üîÑ Restaurar pedidos
      </button>
      <button class="btn-action danger" id="btnClear" onclick="confirmClearCache()">
        üóëÔ∏è Limpar hist√≥rico
      </button>
    </div>

    <!-- Filter Tabs -->
    <div class="tabs">
      <div class="tab active" data-filter="all">Todos</div>
      <div class="tab" data-filter="active">Em andamento</div>
      <div class="tab" data-filter="delivered">Entregues</div>
      <div class="tab" data-filter="cancelled">Cancelados</div>
    </div>

    <!-- Orders List -->
    <div class="orders-list" id="ordersList">
      <div class="empty-state">
        <div class="empty-icon">üì¶</div>
        <div class="empty-title">Carregando...</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Order Detail Modal -->
  <div class="modal-overlay" id="orderModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Detalhes do Pedido</div>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- Confirm Popup -->
  <div class="popup-overlay" id="confirmPopup">
    <div class="popup-box">
      <div class="popup-header">
        <div class="popup-icon" id="popupIcon">üóëÔ∏è</div>
        <div class="popup-title" id="popupTitle">Confirmar</div>
      </div>
      <div class="popup-message" id="popupMessage">Tem certeza?</div>
      <div class="popup-actions">
        <button class="popup-btn cancel" onclick="closePopup()">Cancelar</button>
        <button class="popup-btn danger" id="popupConfirm">Confirmar</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAnIJRcUxN-0swpVnonPbJjTSK87o4CQ_g",
      authDomain: "pedrad-814d0.firebaseapp.com",
      projectId: "pedrad-814d0",
      storageBucket: "pedrad-814d0.appspot.com",
      messagingSenderId: "293587190550",
      appId: "1:293587190550:web:80c9399f82847c80e20637"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ===== CONSTANTS =====
    const ACTIVE_STATUSES = ['pending', 'confirmed', 'preparing', 'ready', 'delivering'];
    const FINAL_STATUSES = ['delivered', 'cancelled'];
    const MAX_FETCH = 5; // M√°ximo de pedidos a buscar do servidor
    const COOLDOWN_HOURS = 24;
    const CACHE_KEY = 'pedrad_orders_cache';
    const COOLDOWN_KEY = 'pedrad_restore_cooldown';

    // ===== STATE =====
    let currentUser = null;
    let orders = []; // Todos os pedidos (cache + ativos)
    let currentFilter = 'all';
    let unsubscribeActive = null;

    // ===== AUTH =====
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await init();
      } else {
        location.href = 'index.html';
      }
    });

    // ===== INIT =====
    async function init() {
      // 1. Carrega cache local
      loadFromCache();
      renderOrders();

      // 2. Listener real-time para pedidos em andamento
      listenActiveOrders();

      // 3. Verifica cooldown
      updateCooldownUI();

      // 4. Bind tabs
      bindTabs();
    }

    // ===== CACHE =====
    function getCacheData() {
      try {
        const data = localStorage.getItem(CACHE_KEY);
        if (!data) return { orders: [], userId: null };
        const parsed = JSON.parse(data);
        // Verifica se √© do mesmo usu√°rio
        if (parsed.userId !== currentUser.uid) return { orders: [], userId: null };
        return parsed;
      } catch {
        return { orders: [], userId: null };
      }
    }

    function saveToCache() {
      try {
        // Salva APENAS pedidos finalizados (entregues/cancelados)
        const finalOrders = orders.filter(o => FINAL_STATUSES.includes(o.status));
        const data = {
          userId: currentUser.uid,
          orders: finalOrders,
          updatedAt: Date.now()
        };
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('Erro ao salvar cache:', e);
      }
    }

    function loadFromCache() {
      const cached = getCacheData();
      // Carrega apenas pedidos finalizados do cache
      orders = cached.orders || [];
    }

    function clearCache() {
      // Remove apenas pedidos finalizados, mant√©m em andamento
      orders = orders.filter(o => ACTIVE_STATUSES.includes(o.status));
      localStorage.removeItem(CACHE_KEY);
      renderOrders();
      showToast('‚úì Hist√≥rico limpo');
    }

    // ===== COOLDOWN =====
    function getCooldownEnd() {
      try {
        const data = localStorage.getItem(COOLDOWN_KEY);
        if (!data) return null;
        const parsed = JSON.parse(data);
        if (parsed.userId !== currentUser.uid) return null;
        return parsed.endsAt;
      } catch {
        return null;
      }
    }

    function setCooldown() {
      const endsAt = Date.now() + (COOLDOWN_HOURS * 60 * 60 * 1000);
      localStorage.setItem(COOLDOWN_KEY, JSON.stringify({
        userId: currentUser.uid,
        endsAt: endsAt
      }));
      updateCooldownUI();
    }

    function isOnCooldown() {
      const endsAt = getCooldownEnd();
      if (!endsAt) return false;
      return Date.now() < endsAt;
    }

    function updateCooldownUI() {
      const endsAt = getCooldownEnd();
      const infoEl = document.getElementById('cooldownInfo');
      const btnRestore = document.getElementById('btnRestore');
      const timeEl = document.getElementById('cooldownTime');

      if (!endsAt || Date.now() >= endsAt) {
        infoEl.style.display = 'none';
        btnRestore.disabled = false;
        return;
      }

      infoEl.style.display = 'block';
      btnRestore.disabled = true;

      // Atualiza tempo restante
      const updateTime = () => {
        const remaining = endsAt - Date.now();
        if (remaining <= 0) {
          infoEl.style.display = 'none';
          btnRestore.disabled = false;
          return;
        }
        const hours = Math.floor(remaining / (1000 * 60 * 60));
        const mins = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        timeEl.textContent = `${hours}h ${mins}min`;
      };

      updateTime();
      setInterval(updateTime, 60000); // Atualiza a cada minuto
    }

    // ===== LISTEN ACTIVE ORDERS =====
    function listenActiveOrders() {
      if (unsubscribeActive) unsubscribeActive();

      unsubscribeActive = db.collection('orders')
        .where('userId', '==', currentUser.uid)
        .where('status', 'in', ACTIVE_STATUSES)
        .onSnapshot(snapshot => {
          // Remove pedidos ativos antigos
          orders = orders.filter(o => !ACTIVE_STATUSES.includes(o.status));

          // Adiciona/atualiza pedidos ativos do servidor
          snapshot.docs.forEach(doc => {
            const order = { id: doc.id, ...doc.data() };
            orders.push(order);
          });

          // Se algum pedido mudou para finalizado, salva no cache
          saveToCache();
          renderOrders();
        }, err => {
          console.error('Erro no listener:', err);
        });
    }

    // ===== RESTORE ORDERS =====
    async function restoreOrders() {
      if (isOnCooldown()) {
        showToast('‚è≥ Aguarde o cooldown');
        return;
      }

      const btn = document.getElementById('btnRestore');
      btn.disabled = true;
      btn.textContent = '‚è≥ Restaurando...';

      try {
        // Busca os 5 pedidos FINALIZADOS mais recentes do servidor
        const snapshot = await db.collection('orders')
          .where('userId', '==', currentUser.uid)
          .where('status', 'in', FINAL_STATUSES)
          .orderBy('createdAt', 'desc')
          .limit(MAX_FETCH)
          .get();

        let added = 0;
        snapshot.docs.forEach(doc => {
          const order = { id: doc.id, ...doc.data() };
          // S√≥ adiciona se n√£o existir
          if (!orders.find(o => o.id === order.id)) {
            orders.push(order);
            added++;
          }
        });

        // Salva no cache
        saveToCache();

        // Ativa cooldown
        setCooldown();

        renderOrders();
        showToast(`‚úì ${added} pedido(s) restaurado(s)`);

      } catch (err) {
        console.error('Erro ao restaurar:', err);
        showToast('Erro ao restaurar');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Restaurar pedidos';
        updateCooldownUI();
      }
    }

    // ===== REFRESH =====
    async function refreshOrders() {
      showToast('‚è≥ Atualizando...');
      // O listener j√° mant√©m os ativos atualizados
      // Apenas for√ßa re-render
      renderOrders();
      showToast('‚úì Atualizado');
    }

    // ===== RENDER =====
    function renderOrders() {
      updateStats();
      updateHeaderBadge();

      const container = document.getElementById('ordersList');

      // Filtra e ordena
      let filtered = [...orders];

      if (currentFilter === 'active') {
        filtered = filtered.filter(o => ACTIVE_STATUSES.includes(o.status));
      } else if (currentFilter === 'delivered') {
        filtered = filtered.filter(o => o.status === 'delivered');
      } else if (currentFilter === 'cancelled') {
        filtered = filtered.filter(o => o.status === 'cancelled');
      }

      // Ordena: mais recentes primeiro
      filtered.sort((a, b) => {
        const dateA = toTimestamp(a.createdAt);
        const dateB = toTimestamp(b.createdAt);
        return dateB - dateA;
      });

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <div class="empty-title">Nenhum pedido ${currentFilter !== 'all' ? 'nesta categoria' : ''}</div>
            <div class="empty-desc">
              ${currentFilter === 'all' ? 'Fa√ßa seu primeiro pedido!' : 'Tente outra categoria'}
            </div>
          </div>
        `;
        return;
      }

      container.innerHTML = filtered.map(order => {
        const isActive = ACTIVE_STATUSES.includes(order.status);
        const storeName = order.storeName || 'Loja';
        const dateStr = formatDate(order.createdAt);
        const itemsPreview = (order.items || []).slice(0, 3)
          .map(i => `${i.qty}x ${i.name}`).join(', ');
        const code = order.id.slice(-6).toUpperCase();

        return `
          <div class="order-card ${isActive ? 'active-order' : ''}" onclick="openOrderDetail('${order.id}')">
            <div class="order-header">
              <div>
                <div class="order-store">${escapeHtml(storeName)}</div>
                <div class="order-meta">${dateStr}</div>
              </div>
              <span class="order-status status-${order.status}">${getStatusLabel(order.status)}</span>
            </div>
            <div class="order-items">${escapeHtml(itemsPreview) || 'Itens do pedido'}</div>
            <div class="order-footer">
              <span class="order-total">${formatCurrency(order.total)}</span>
              <span class="order-code">#${code}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateStats() {
      const active = orders.filter(o => ACTIVE_STATUSES.includes(o.status)).length;
      const delivered = orders.filter(o => o.status === 'delivered').length;
      const total = orders.length;

      document.getElementById('statActive').textContent = active;
      document.getElementById('statDelivered').textContent = delivered;
      document.getElementById('statTotal').textContent = total;
    }

    function updateHeaderBadge() {
      const badge = document.getElementById('headerBadge');
      badge.textContent = `${orders.length} pedido${orders.length !== 1 ? 's' : ''}`;
    }

    // ===== TABS =====
    function bindTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.filter;
          renderOrders();
        });
      });
    }

    // ===== ORDER DETAIL =====
    function openOrderDetail(orderId) {
      const order = orders.find(o => o.id === orderId);
      if (!order) return;

      const modal = document.getElementById('orderModal');
      const title = document.getElementById('modalTitle');
      const body = document.getElementById('modalBody');

      const storeName = order.storeName || 'Loja';
      const code = order.id.slice(-6).toUpperCase();

      title.textContent = storeName;

      const addr = order.address || {};
      const fullAddress = [
        addr.street,
        addr.number ? `n¬∫ ${addr.number}` : '',
        addr.neighborhood
      ].filter(Boolean).join(', ');

      const paymentLabels = {
        pix: 'üí† PIX', credit: 'üí≥ Cr√©dito', debit: 'üí≥ D√©bito',
        cash: 'üíµ Dinheiro', picpay: 'üíö PicPay'
      };
      const paymentMethod = paymentLabels[order.paymentMethod] || order.paymentMethod || '‚Äî';

      const deliveryFee = order.deliveryFee || 0;
      const subtotal = (order.total || 0) - deliveryFee;

      const isDelivered = order.status === 'delivered';
      const isReviewed = order.reviewed === true;

      body.innerHTML = `
        <div class="detail-section">
          <div class="detail-title">üìã Informa√ß√µes</div>
          <div class="detail-row">
            <span class="label">C√≥digo</span>
            <span class="value">#${code}</span>
          </div>
          <div class="detail-row">
            <span class="label">Status</span>
            <span class="value">${getStatusLabel(order.status)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Data</span>
            <span class="value">${formatDate(order.createdAt)}</span>
          </div>
          <div class="detail-row">
            <span class="label">Entrega</span>
            <span class="value">${order.deliveryMode === 'pickup' ? 'Retirada' : 'Delivery'}</span>
          </div>
          ${fullAddress ? `
          <div class="detail-row">
            <span class="label">Endere√ßo</span>
            <span class="value">${escapeHtml(fullAddress)}</span>
          </div>
          ` : ''}
        </div>

        <div class="detail-section">
          <div class="detail-title">üõí Itens</div>
          ${(order.items || []).map(item => {
            const addons = (item.addons || []).map(a => a.name).join(', ');
            const itemPrice = (item.price || 0) * (item.qty || 1);
            return `
              <div class="item-row">
                <span class="item-qty">${item.qty}x</span>
                <span class="item-name">
                  ${escapeHtml(item.name)}
                  ${addons ? `<div class="item-addons">+ ${escapeHtml(addons)}</div>` : ''}
                </span>
                <span class="item-price">${formatCurrency(itemPrice)}</span>
              </div>
            `;
          }).join('')}
        </div>

        <div class="detail-section">
          <div class="detail-title">üí∞ Pagamento</div>
          <div class="detail-row">
            <span class="label">Forma</span>
            <span class="value">${paymentMethod}</span>
          </div>
          <div class="detail-row">
            <span class="label">Subtotal</span>
            <span class="value">${formatCurrency(subtotal)}</span>
          </div>
          ${deliveryFee > 0 ? `
          <div class="detail-row">
            <span class="label">Taxa de entrega</span>
            <span class="value">${formatCurrency(deliveryFee)}</span>
          </div>
          ` : ''}
          <div class="detail-row">
            <span class="label"><strong>Total</strong></span>
            <span class="value"><strong>${formatCurrency(order.total)}</strong></span>
          </div>
        </div>

        ${isDelivered && !isReviewed ? `
          <button class="btn-review" onclick="goToReview('${order.id}')">
            ‚≠ê Avaliar Pedido
          </button>
        ` : ''}

        ${isReviewed ? `
          <div class="reviewed-badge">‚úì Pedido avaliado</div>
        ` : ''}
      `;

      modal.classList.add('show');
    }

    function closeModal() {
      document.getElementById('orderModal').classList.remove('show');
    }

    function goToReview(orderId) {
      closeModal();
      location.href = `review.html?orderId=${orderId}`;
    }

    // ===== CONFIRM CLEAR =====
    function confirmClearCache() {
      const activeCount = orders.filter(o => ACTIVE_STATUSES.includes(o.status)).length;
      const finalCount = orders.filter(o => FINAL_STATUSES.includes(o.status)).length;

      if (finalCount === 0) {
        showToast('Nenhum hist√≥rico para limpar');
        return;
      }

      document.getElementById('popupIcon').textContent = 'üóëÔ∏è';
      document.getElementById('popupTitle').textContent = 'Limpar hist√≥rico?';
      document.getElementById('popupMessage').textContent = 
        `${finalCount} pedido(s) finalizado(s) ser√£o removidos do hist√≥rico local.\n\n` +
        `${activeCount > 0 ? `‚úì ${activeCount} pedido(s) em andamento ser√£o mantidos.` : ''}`;
      
      document.getElementById('popupConfirm').className = 'popup-btn danger';
      document.getElementById('popupConfirm').textContent = 'Limpar';
      document.getElementById('popupConfirm').onclick = () => {
        closePopup();
        clearCache();
      };

      document.getElementById('confirmPopup').classList.add('show');
    }

    function closePopup() {
      document.getElementById('confirmPopup').classList.remove('show');
    }

    // ===== UTILS =====
    function toTimestamp(ts) {
      if (!ts) return 0;
      if (typeof ts.toDate === 'function') return ts.toDate().getTime();
      if (typeof ts === 'number') return ts;
      const d = new Date(ts);
      return isNaN(d.getTime()) ? 0 : d.getTime();
    }

    function formatDate(ts) {
      const ms = toTimestamp(ts);
      if (!ms) return '‚Äî';
      const d = new Date(ms);
      return d.toLocaleDateString('pt-BR', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function formatCurrency(v) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency', currency: 'BRL'
      }).format(v || 0);
    }

    function getStatusLabel(status) {
      const labels = {
        pending: 'üü° Pendente',
        confirmed: 'üîµ Confirmado',
        preparing: 'üü£ Preparando',
        ready: 'üü¢ Pronto',
        delivering: 'üöÄ Em entrega',
        delivered: '‚úÖ Entregue',
        cancelled: '‚ùå Cancelado'
      };
      return labels[status] || status;
    }

    function escapeHtml(str) {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function goBack() {
      if (document.referrer.includes(location.host)) {
        history.back();
      } else {
        location.href = 'index.html';
      }
    }

    // Close modals on overlay click
    document.getElementById('orderModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
    document.getElementById('confirmPopup').addEventListener('click', function(e) {
      if (e.target === this) closePopup();
    });
  </script>
</body>
</html>